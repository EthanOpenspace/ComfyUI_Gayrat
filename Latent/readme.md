# Flux/SD Latent Image Custom Node

Custom node для ComfyUI, который создает правильно инициализированные латентные изображения для моделей Flux и Stable Diffusion с поддержкой различных соотношений сторон.

## Особенности

- ✅ Поддержка Flux, Flux PRO, Flux Ultra и Stable Diffusion
- ✅ Автоматическая правильная инициализация для каждой модели
- ✅ Предустановленные размеры, кратные 32
- ✅ Поддержка соотношений сторон: 1:1, 4:3, 3:4, 16:9, 9:16
- ✅ Динамическое обновление списка размеров
- ✅ Оптимизация типов данных (fp16 для Flux, fp32 для SD)

## Установка

### 1. Копирование файлов Python

```bash
# Создайте папку для custom node
cd ComfyUI/custom_nodes
mkdir flux_sd_latent
cd flux_sd_latent

# Скопируйте файл flux_sd_latent_node.py в эту папку
# Создайте __init__.py файл:
echo "from .flux_sd_latent_node import NODE_CLASS_MAPPINGS, NODE_DISPLAY_NAME_MAPPINGS" > __init__.py
```

### 2. Установка JavaScript расширения (опционально)

```bash
# Создайте папку для расширения
cd ComfyUI/web/extensions
mkdir flux_sd_latent

# Скопируйте файл flux_sd_latent.js в эту папку
```

### 3. Перезапустите ComfyUI

## Использование

### Входные параметры:

- **model**: Выбор модели
  - Flux / Flux PRO / Flux Ultra - 16 каналов, случайная инициализация
  - SD - 4 канала, константная инициализация (0.0609)

- **aspect_ratio**: Соотношение сторон
  - 1:1 - квадратные изображения
  - 4:3 / 3:4 - стандартные фото
  - 16:9 / 9:16 - широкоформатные

- **size**: Размер изображения (автоматически обновляется)
  - Для Flux: рекомендуется 1024x1024 и выше
  - Для SD: рекомендуется 512x512

- **batch_size**: Количество изображений (1-64)

- **seed**: Сид для воспроизводимости

### Выходные параметры:

- **width**: Ширина изображения (INT)
- **height**: Высота изображения (INT)
- **latent**: Латентный тензор для подключения к KSampler

## Примеры использования

### Базовый workflow для Flux:
```
[Flux/SD Latent Image] → [KSampler] → [VAE Decode] → [Save Image]
         ↓
    model: Flux
    aspect: 1:1
    size: 1024x1024
```

### Workflow для SD с пользовательским размером:
```
[Flux/SD Latent Image] → [KSampler] → [VAE Decode] → [Save Image]
         ↓
    model: SD
    aspect: 16:9
    size: 1280x720
```

## Технические детали

### Инициализация латентов:

**Flux модели:**
```python
# Случайный шум, fp16
latent = torch.randn([batch, 16, H//8, W//8], dtype=torch.float16)
```

**SD модель:**
```python
# Константа 0.0609, fp32
latent = torch.ones([batch, 4, H//8, W//8], dtype=torch.float32) * 0.0609
```

### Доступные размеры:

Все размеры кратны 32 для оптимальной производительности:

- **1:1**: от 512x512 до 1408x1408
- **4:3**: от 512x384 до 1408x1056
- **3:4**: от 384x512 до 1056x1408
- **16:9**: от 512x288 до 1920x1088
- **9:16**: от 288x512 до 1088x1920

## Требования

- ComfyUI (последняя версия)
- PyTorch с поддержкой CUDA (для GPU)
- Достаточно VRAM для выбранного размера

## Решение проблем

### "Size not valid for aspect ratio"
- Убедитесь, что выбранный размер соответствует соотношению сторон
- Используйте динамическое обновление размеров

### Нехватка памяти
- Уменьшите размер изображения
- Уменьшите batch_size
- Используйте квантованные модели

### JavaScript не работает
- Убедитесь, что файл находится в правильной папке
- Очистите кэш браузера (Ctrl+F5)
- Проверьте консоль браузера на ошибки

## Лицензия

MIT License - свободно используйте и модифицируйте